---
title: "Lecture 10 plyr and reshape2"
author: "David McAllister"
date: "Tuesday, August 5th, 2014"
output: ioslides_presentation
---

## Objective of section
* To see how plyr and reshape 2 can be used as extensions to base R

# Apply functions are great for interactive work, but a nightmare for reproducible research

## Apply functions
- Different argument orders
- Different outputs depending on lots of factors

## Why plyr was written
- plyr is a family saloon car not a rocket

## Perform same as last exercise
```{r}
# Create excerpt
head(esoph,3)
esoph$heavy.smoker <- esoph$tob %in% c("20-29", "30+")
esoph$heavy.smoker <- as.numeric (esoph$heavy.smoker)
excerpt <- subset (esoph, agegp == "65-74")
```

## Write function
``` {r}
MyModelExtract <- function (x){
  output <- glm(cbind (ncases, ncontrols) ~ heavy.smoker, data = x,
                family = binomial)
  output$coef["heavy.smoker"]
} 
MyModelExtract (excerpt)
```

## Apply function using plyr
``` {r}
library (plyr)
ddply (esoph, .(agegp), MyModelExtract)
```

## Compare it to by
``` {r}
by (esoph, esoph$agegp, MyModelExtract)
```

## Whats so good about that?
Consistency
```{r}
ddply (esoph, .(agegp), summarise,
  n = sum(ncases + ncontrols),
  ncases.heavy = sum (ncases * heavy.smoker),
  ncontrols.heavy = sum (ncontrols * heavy.smoker))
```

## Summarize and transform
``` {r}
# Very consistent code
esoph$sbp <- rnorm (mean = 150, sd = 30, n = nrow(esoph))
esoph.new <- ddply (esoph, .(agegp, heavy.smoker), transform,
  within.row = seq_along(agegp),
  sbp.std = (sbp - mean(sbp)) / sd(sbp)
  )
head(esoph.new)
```

```{r}
# Similar if want to summarize
esoph.new <- ddply (esoph.new, .(agegp, heavy.smoker), summarise,
  mean.sbp.std = mean (sbp.std),
  sd.sbp.std = sd (sbp.std),
  n = max(within.row)
  )
head(esoph.new)
```

# Reshape 2

## Elegant
- combines reshaping and aggregation in a single system
- warning, can be slow

## Dataset time series
```{r, echo=FALSE}
library(reshape2)
df <- data.frame (id = 1:20, age = rep(1:10,2), sex = rep(c("male", "female"),each = 10))
df <- df[rep(1:nrow(df),5),]
df$t <- rep(0:4, each = 20)
df$value <- with (df, age* 0 + 1.2*t + age*t*0.8 + rnorm (length(age), mean = 0, sd = 2))
df <- dcast (df, id + age + sex ~ t, value.var = "value")
df
```

## Make it longitudinal
```{r}
library (reshape2)
df.melt <- melt(df, id = c("id", "age", "sex"))
df.melt$time <- as.numeric (df.melt$variable)
df.melt
```

## examine data
```{r}
## 5 measures at each time point by age and sex 
dcast (df.melt, sex ~ age , value.var = "value", fun = length)
dcast (df.melt, sex ~ age , value.var = "value", fun = mean )
```

## Two-step model
``` {r}
excerpt <- subset(df.melt, id ==1)
MyModelExtract <- function (x){
  output <- lm( value ~ time, data = x)
  output <- output$coef
  names(output) <- c("intercept", "slope")
  output
} 
MyModelExtract (excerpt)
```

## Create aggregated dataset
``` {r}
df.sum <- ddply (df.melt, .(id, age, sex), MyModelExtract)
head(df.sum)
```

## Run second level in model
```{r}
model.slope <- lm(slope ~ age + sex, data = df.sum)
model.intercept <- lm(intercept ~ age + sex, data = df.sum)
coef(model.intercept)
coef(model.slope)
```

## other packages
doby, dplyr, sqldf